<?php
/**
 * =============================================================================
 * VIDEOCHAT.PHP â€” ĞĞ´Ğ½Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ WebRTC Ğ²Ğ¸Ğ´ĞµĞ¾+Ñ‚ĞµĞºÑÑ‚ Ñ‡Ğ°Ñ‚ Ğ´Ğ»Ñ 2 Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
 * =============================================================================
 *
 * Ğ”Ğ•ĞŸĞ›ĞĞ™:
 *   1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ° PHP-Ñ…Ğ¾ÑÑ‚Ğ¸Ğ½Ğ³ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ² ĞºĞ¾Ñ€ĞµĞ½ÑŒ ÑĞ°Ğ¹Ñ‚Ğ°).
 *   2. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ PHP Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Ñ‚Ğ¾Ğ¹ Ğ¶Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
 *      (Ğ¿Ñ€Ğ°Ğ²Ğ° 755/775 Ğ½Ğ° Ğ¿Ğ°Ğ¿ĞºÑƒ). state.json Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.
 *   3. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ: https://yourdomain.com/videochat.php
 *   4. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€/Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ â€” Ğ¾Ğ½ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ slot2 Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ñ‘Ñ‚ÑÑ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº.
 *
 * Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•:
 *   - ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ´Ğ²Ğ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ° (Ğ½Ğµ Ğ´Ğ²Ğµ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾) Ğ¸Ğ»Ğ¸ Ğ¸Ğ½ĞºĞ¾Ğ³Ğ½Ğ¸Ñ‚Ğ¾.
 *   - ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ â†’ slot1 (caller), Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ â†’ slot2 (callee).
 *   - Caller ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ offer Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸, callee Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞµĞ³Ğ¾ Ñ‡ĞµÑ€ĞµĞ· polling.
 *   - Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ?debug=1 Ğ² URL â€” Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ state.json.
 *   - ĞŸÑ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ ÑĞ»Ğ¾Ñ‚ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· heartbeat-Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ (~12Ñ).
 *
 * ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜:
 *   Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.
 * =============================================================================
 */

// â”€â”€â”€ ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

define('STATE_FILE',        __DIR__ . '/state.json');   // Ğ¤Ğ°Ğ¹Ğ» ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
define('PING_TIMEOUT',      15);    // Ğ¡ĞµĞºÑƒĞ½Ğ´ Ğ´Ğ¾ ÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ñ‘Ğ½Ğ½Ñ‹Ğ¼
define('MAX_ICE_QUEUE',     200);   // ĞœĞ°ĞºÑ. ICE-ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ğ² Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
define('MAX_MSGS',          200);   // ĞœĞ°ĞºÑ. ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚Ğ°
define('MAX_SIGNAL_QUEUE',  10);    // ĞœĞ°ĞºÑ. offer/answer Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
define('STUN_SERVER',       'stun:stun.l.google.com:19302'); // STUN ÑĞµÑ€Ğ²ĞµÑ€

// â”€â”€â”€ ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ AJAX-Ğ—ĞĞŸĞ ĞĞ¡ĞĞ’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$action = $_REQUEST['action'] ?? null;

// Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸ â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ state.json (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸!)
if (isset($_GET['debug']) && $_GET['debug'] === '1') {
    header('Content-Type: application/json; charset=utf-8');
    $state = readState();
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° ping-timeout'Ğ¾Ğ²
    $state['_now'] = time();
    $state['_ping_timeout'] = PING_TIMEOUT;
    echo json_encode($state, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
    exit;
}

// Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ action â€” ÑÑ‚Ğ¾ AJAX Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ, Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼
if ($action !== null) {
    header('Content-Type: application/json; charset=utf-8');
    header('Cache-Control: no-store, no-cache, must-revalidate');

    try {
        switch ($action) {
            case 'join':      echo json_encode(handleJoin());     break;
            case 'ping':      echo json_encode(handlePing());     break;
            case 'leave':     echo json_encode(handleLeave());    break;
            case 'post_offer':  echo json_encode(handlePostOffer()); break;
            case 'post_answer': echo json_encode(handlePostAnswer()); break;
            case 'post_ice':  echo json_encode(handlePostIce());  break;
            case 'poll':      echo json_encode(handlePoll());     break;
            case 'post_msg':  echo json_encode(handlePostMsg());  break;
            default:
                http_response_code(400);
                echo json_encode(['status' => 'error', 'message' => 'Unknown action']);
        }
    } catch (Throwable $e) {
        http_response_code(500);
        echo json_encode(['status' => 'error', 'message' => $e->getMessage()]);
    }
    exit;
}

// â”€â”€â”€ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ STATE.JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ state.json Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹.
 * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€Ğ°ÑĞ¿Ğ°Ñ€ÑĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ.
 */
function readState(): array {
    if (!file_exists(STATE_FILE)) {
        return defaultState();
    }
    $fp = fopen(STATE_FILE, 'r+');
    if (!$fp) throw new RuntimeException('Cannot open state file for reading');
    flock($fp, LOCK_SH);
    $content = stream_get_contents($fp);
    flock($fp, LOCK_UN);
    fclose($fp);
    if (empty($content)) return defaultState();
    $state = json_decode($content, true);
    return is_array($state) ? $state : defaultState();
}

/**
 * ĞÑ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾ Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ state.json Ñ ÑĞºÑĞºĞ»ÑĞ·Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹.
 * $callback Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ state, Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ state.
 */
function updateState(callable $callback): array {
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ„Ğ°Ğ¹Ğ» ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
    $fp = fopen(STATE_FILE, file_exists(STATE_FILE) ? 'r+' : 'w+');
    if (!$fp) throw new RuntimeException('Cannot open state file for writing');

    flock($fp, LOCK_EX); // Ğ­ĞºÑĞºĞ»ÑĞ·Ğ¸Ğ²Ğ½Ğ°Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ°

    $content = stream_get_contents($fp);
    rewind($fp);

    $state = (!empty($content)) ? (json_decode($content, true) ?? defaultState()) : defaultState();

    // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ‚ÑƒÑ…ÑˆĞ¸Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹ Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ĞµĞ¹
    $state = expireSlots($state);

    // ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
    $newState = $callback($state);
    $newState['updated'] = time();

    // Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾
    ftruncate($fp, 0);
    fwrite($fp, json_encode($newState, JSON_UNESCAPED_UNICODE));

    flock($fp, LOCK_UN);
    fclose($fp);

    return $newState;
}

/**
 * Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° state.json Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ.
 * slot1/slot2 â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ²ÑƒÑ… Ğ°Ğ±Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ².
 * msgs â€” Ğ¾Ğ±Ñ‰Ğ°Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚Ğ°.
 */
function defaultState(): array {
    return [
        'slot1' => emptySlot(),
        'slot2' => emptySlot(),
        'msgs'  => [],          // ĞĞ±Ñ‰Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° [{from,text,ts}]
        'created' => time(),
        'updated' => time(),
    ];
}

/** ĞŸÑƒÑÑ‚Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑĞ»Ğ¾Ñ‚Ğ° */
function emptySlot(): array {
    return [
        'clientId'  => null,    // Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ID ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
        'lastPing'  => 0,       // Unix timestamp Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¿Ğ¸Ğ½Ğ³Ğ°
        'offers'    => [],      // SDP offer Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ»Ğ¾Ñ‚Ğ°
        'answers'   => [],      // SDP answer Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ»Ğ¾Ñ‚Ğ°
        'ices'      => [],      // ICE-ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ»Ğ¾Ñ‚Ğ°
    ];
}

/**
 * ĞÑ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ ÑĞ»Ğ¾Ñ‚Ñ‹ Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ¸ÑÑ‚Ñ‘Ğº Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ¿Ğ¸Ğ½Ğ³Ğ°.
 * Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¼ updateState.
 */
function expireSlots(array $state): array {
    $now = time();
    foreach (['slot1', 'slot2'] as $slot) {
        if (!empty($state[$slot]['clientId'])) {
            $lastPing = $state[$slot]['lastPing'] ?? 0;
            if ($now - $lastPing > PING_TIMEOUT) {
                $state[$slot] = emptySlot();
            }
        }
    }
    return $state;
}

// â”€â”€â”€ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ ENDPOINTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * action=join
 * Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°. ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ ÑĞ»Ğ¾Ñ‚ 1 Ğ¸Ğ»Ğ¸ 2.
 * Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ° Ğ·Ğ°Ğ½ÑÑ‚Ñ‹ â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ status=busy.
 * Body: clientId (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ)
 */
function handleJoin(): array {
    $clientId = $_POST['clientId'] ?? $_GET['clientId'] ?? null;

    $result = null;

    updateState(function($state) use ($clientId, &$result) {
        $now = time();

        // Ğ•ÑĞ»Ğ¸ clientId ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¸Ğ· ÑĞ»Ğ¾Ñ‚Ğ¾Ğ² â€” Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ
        foreach (['slot1', 'slot2'] as $slotKey) {
            if ($state[$slotKey]['clientId'] === $clientId && $clientId !== null) {
                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¸Ğ½Ğ³ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ ÑĞ»Ğ¾Ñ‚
                $state[$slotKey]['lastPing'] = $now;
                $peerSlot = ($slotKey === 'slot1') ? 'slot2' : 'slot1';
                $result = [
                    'status'   => 'ok',
                    'slot'     => (int)substr($slotKey, 4),
                    'clientId' => $clientId,
                    'peerSlot' => (int)substr($peerSlot, 4),
                    'peerConnected' => !empty($state[$peerSlot]['clientId']),
                    'reconnected' => true,
                ];
                return $state;
            }
        }

        // ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ÑĞ»Ğ¾Ñ‚
        $assignedSlot = null;
        if (empty($state['slot1']['clientId'])) {
            $assignedSlot = 'slot1';
        } elseif (empty($state['slot2']['clientId'])) {
            $assignedSlot = 'slot2';
        }

        if ($assignedSlot === null) {
            $result = ['status' => 'busy'];
            return $state;
        }

        // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ clientId ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½
        if (!$clientId) {
            $clientId = bin2hex(random_bytes(8));
        }

        $state[$assignedSlot] = emptySlot();
        $state[$assignedSlot]['clientId'] = $clientId;
        $state[$assignedSlot]['lastPing'] = $now;

        $peerSlot = ($assignedSlot === 'slot1') ? 'slot2' : 'slot1';

        $result = [
            'status'   => 'ok',
            'slot'     => (int)substr($assignedSlot, 4),
            'clientId' => $clientId,
            'peerSlot' => (int)substr($peerSlot, 4),
            'peerConnected' => !empty($state[$peerSlot]['clientId']),
            'reconnected' => false,
        ];

        return $state;
    });

    return $result;
}

/**
 * action=ping
 * ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ lastPing Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°. ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ»Ğ¾Ñ‚ Ğ¶Ğ¸Ğ²Ñ‹Ğ¼.
 */
function handlePing(): array {
    $clientId = $_POST['clientId'] ?? $_GET['clientId'] ?? null;
    $slot = (int)($_POST['slot'] ?? $_GET['slot'] ?? 0);

    if (!$clientId || !$slot) return ['status' => 'error', 'message' => 'Missing params'];

    $slotKey = 'slot' . $slot;
    $found = false;

    updateState(function($state) use ($clientId, $slotKey, &$found) {
        if (($state[$slotKey]['clientId'] ?? null) === $clientId) {
            $state[$slotKey]['lastPing'] = time();
            $found = true;
        }
        return $state;
    });

    return $found ? ['status' => 'ok'] : ['status' => 'error', 'message' => 'Slot not found'];
}

/**
 * action=leave
 * Ğ¯Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° â€” Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ ĞµĞ³Ğ¾ ÑĞ»Ğ¾Ñ‚.
 */
function handleLeave(): array {
    $clientId = $_POST['clientId'] ?? $_GET['clientId'] ?? null;
    $slot = (int)($_POST['slot'] ?? $_GET['slot'] ?? 0);

    if (!$clientId || !$slot) return ['status' => 'error', 'message' => 'Missing params'];

    $slotKey = 'slot' . $slot;

    updateState(function($state) use ($clientId, $slotKey) {
        if (($state[$slotKey]['clientId'] ?? null) === $clientId) {
            $state[$slotKey] = emptySlot();
        }
        return $state;
    });

    return ['status' => 'ok'];
}

/**
 * action=post_offer
 * Caller (slot1) Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ SDP offer Ğ´Ğ»Ñ callee (slot2).
 * Offer ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² slot2.offers â€” Ñ‚.Ğµ. Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ´Ğ»Ñ slot2.
 */
function handlePostOffer(): array {
    $clientId = $_POST['clientId'] ?? null;
    $slot = (int)($_POST['slot'] ?? 0);
    $offer = $_POST['offer'] ?? null; // JSON-ÑÑ‚Ñ€Ğ¾ĞºĞ° SDP

    if (!$clientId || !$slot || !$offer) return ['status' => 'error', 'message' => 'Missing params'];

    $mySlotKey   = 'slot' . $slot;
    $peerSlotKey = 'slot' . (($slot === 1) ? 2 : 1);

    updateState(function($state) use ($clientId, $mySlotKey, $peerSlotKey, $offer) {
        if (($state[$mySlotKey]['clientId'] ?? null) !== $clientId) return $state;
        // ĞšĞ»Ğ°Ğ´Ñ‘Ğ¼ offer Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ´Ğ»Ñ peer
        if (count($state[$peerSlotKey]['offers']) < MAX_SIGNAL_QUEUE) {
            $state[$peerSlotKey]['offers'][] = $offer;
        }
        return $state;
    });

    return ['status' => 'ok'];
}

/**
 * action=post_answer
 * Callee (slot2) Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ SDP answer Ğ´Ğ»Ñ caller (slot1).
 */
function handlePostAnswer(): array {
    $clientId = $_POST['clientId'] ?? null;
    $slot = (int)($_POST['slot'] ?? 0);
    $answer = $_POST['answer'] ?? null;

    if (!$clientId || !$slot || !$answer) return ['status' => 'error', 'message' => 'Missing params'];

    $mySlotKey   = 'slot' . $slot;
    $peerSlotKey = 'slot' . (($slot === 1) ? 2 : 1);

    updateState(function($state) use ($clientId, $mySlotKey, $peerSlotKey, $answer) {
        if (($state[$mySlotKey]['clientId'] ?? null) !== $clientId) return $state;
        if (count($state[$peerSlotKey]['answers']) < MAX_SIGNAL_QUEUE) {
            $state[$peerSlotKey]['answers'][] = $answer;
        }
        return $state;
    });

    return ['status' => 'ok'];
}

/**
 * action=post_ice
 * Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ ICE-ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ° Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ´Ğ»Ñ peer.
 */
function handlePostIce(): array {
    $clientId   = $_POST['clientId'] ?? null;
    $slot       = (int)($_POST['slot'] ?? 0);
    $candidate  = $_POST['candidate'] ?? null;

    if (!$clientId || !$slot || !$candidate) return ['status' => 'error', 'message' => 'Missing params'];

    $mySlotKey   = 'slot' . $slot;
    $peerSlotKey = 'slot' . (($slot === 1) ? 2 : 1);

    updateState(function($state) use ($clientId, $mySlotKey, $peerSlotKey, $candidate) {
        if (($state[$mySlotKey]['clientId'] ?? null) !== $clientId) return $state;
        if (count($state[$peerSlotKey]['ices']) < MAX_ICE_QUEUE) {
            $state[$peerSlotKey]['ices'][] = $candidate;
        }
        return $state;
    });

    return ['status' => 'ok'];
}

/**
 * action=poll
 * Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ polling endpoint. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:
 * - offers, answers â€” SDP ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¸Ğ½Ğ³
 * - ices â€” ICE ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ñ‹
 * - msgs â€” Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° (Ñ offset)
 * - peerConnected/peerLeft â€” ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ peer
 * ĞŸĞ¾ÑĞ»Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ signals (offers/answers/ices).
 */
function handlePoll(): array {
    $clientId  = $_POST['clientId'] ?? $_GET['clientId'] ?? null;
    $slot      = (int)($_POST['slot'] ?? $_GET['slot'] ?? 0);
    $msgOffset = (int)($_POST['msgOffset'] ?? $_GET['msgOffset'] ?? 0);

    if (!$clientId || !$slot) return ['status' => 'error', 'message' => 'Missing params'];

    $mySlotKey   = 'slot' . $slot;
    $peerSlotKey = 'slot' . (($slot === 1) ? 2 : 1);

    $pollResult = null;

    updateState(function($state) use ($clientId, $mySlotKey, $peerSlotKey, $msgOffset, &$pollResult) {
        if (($state[$mySlotKey]['clientId'] ?? null) !== $clientId) {
            $pollResult = ['status' => 'error', 'message' => 'Not authorized'];
            return $state;
        }

        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¸Ğ½Ğ³ Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ poll
        $state[$mySlotKey]['lastPing'] = time();

        // Ğ—Ğ°Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ²
        $offers  = $state[$mySlotKey]['offers'];
        $answers = $state[$mySlotKey]['answers'];
        $ices    = $state[$mySlotKey]['ices'];

        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ
        $state[$mySlotKey]['offers']  = [];
        $state[$mySlotKey]['answers'] = [];
        $state[$mySlotKey]['ices']    = [];

        // ĞĞ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ offset
        $allMsgs = $state['msgs'] ?? [];
        $newMsgs = array_slice($allMsgs, $msgOffset);

        // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ°
        if (count($allMsgs) > MAX_MSGS) {
            $state['msgs'] = array_slice($allMsgs, -MAX_MSGS);
        }

        // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ peer
        $peerConnected = !empty($state[$peerSlotKey]['clientId']);
        $peerLastPing  = $state[$peerSlotKey]['lastPing'] ?? 0;

        $pollResult = [
            'status'        => 'ok',
            'offers'        => $offers,
            'answers'       => $answers,
            'ices'          => $ices,
            'msgs'          => $newMsgs,
            'msgTotal'      => count($allMsgs),
            'peerConnected' => $peerConnected,
            'peerLastPing'  => $peerLastPing,
            'serverTime'    => time(),
        ];

        return $state;
    });

    return $pollResult ?? ['status' => 'error'];
}

/**
 * action=post_msg
 * Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚.
 */
function handlePostMsg(): array {
    $clientId = $_POST['clientId'] ?? null;
    $slot     = (int)($_POST['slot'] ?? 0);
    $text     = $_POST['text'] ?? '';

    if (!$clientId || !$slot) return ['status' => 'error', 'message' => 'Missing params'];
    if (trim($text) === '') return ['status' => 'error', 'message' => 'Empty message'];

    // Ğ¡Ğ°Ğ½Ğ¸Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: Ğ¾Ğ±Ñ€ĞµĞ·Ğ°ĞµĞ¼ Ğ¸ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‰Ğ¸Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
    $text = mb_substr(trim($text), 0, 1000);

    $slotKey = 'slot' . $slot;

    updateState(function($state) use ($clientId, $slotKey, $slot, $text) {
        if (($state[$slotKey]['clientId'] ?? null) !== $clientId) return $state;

        $state['msgs'][] = [
            'from' => $slot,
            'text' => $text,
            'ts'   => time(),
        ];

        // ĞĞ±Ñ€ĞµĞ·Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
        if (count($state['msgs']) > MAX_MSGS) {
            $state['msgs'] = array_slice($state['msgs'], -MAX_MSGS);
        }

        return $state;
    });

    return ['status' => 'ok'];
}

// â”€â”€â”€ HTML/CSS/JS Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ•ÑĞ»Ğ¸ Ğ¼Ñ‹ Ğ·Ğ´ĞµÑÑŒ â€” Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ GET-Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ, Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ğ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
?>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VideoChat</title>
<style>
/* â”€â”€â”€ ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ• Ğ˜ Ğ¡Ğ‘Ğ ĞĞ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:         #080c10;
  --surface:    #0d1520;
  --surface2:   #111d2e;
  --border:     #1e3048;
  --accent:     #00d4ff;
  --accent2:    #0077ff;
  --text:       #c8dff0;
  --text-dim:   #4a6a8a;
  --danger:     #ff4466;
  --success:    #00e676;
  --font-mono:  'Courier New', 'Lucida Console', monospace;
  --font-main:  Georgia, 'Times New Roman', serif;
  --radius:     8px;
  --shadow:     0 8px 32px rgba(0,0,0,0.6);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  width: 100%; height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-main);
  overflow: hidden;
}

/* â”€â”€â”€ Ğ­ĞšĞ ĞĞ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ˜ / Ğ—ĞĞĞ¯Ğ¢Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-loading, #screen-busy, #screen-error {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: var(--bg);
  z-index: 100;
}

.logo {
  font-family: var(--font-mono);
  font-size: clamp(1.4rem, 4vw, 2.2rem);
  letter-spacing: 0.15em;
  color: var(--accent);
  text-shadow: 0 0 20px rgba(0,212,255,0.4);
  margin-bottom: 1.5rem;
}
.logo span { color: var(--text-dim); }

.status-msg {
  font-family: var(--font-mono);
  font-size: 0.85rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
}

.spinner {
  width: 36px; height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 1.2rem;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Ğ—Ğ°Ğ½ÑÑ‚Ğ¾ */
.busy-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  filter: drop-shadow(0 0 12px var(--danger));
}
.busy-title {
  font-size: clamp(1.2rem, 3vw, 1.8rem);
  color: var(--danger);
  margin-bottom: 0.75rem;
  text-align: center;
}
.busy-sub {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  color: var(--text-dim);
  text-align: center;
  line-height: 1.8;
}
.retry-btn {
  margin-top: 1.5rem;
  padding: 0.6rem 1.6rem;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 0.8rem;
  letter-spacing: 0.08em;
  cursor: pointer;
  transition: border-color 0.2s, color 0.2s;
}
.retry-btn:hover { border-color: var(--accent); color: var(--accent); }

/* â”€â”€â”€ ĞĞ¡ĞĞĞ’ĞĞĞ™ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#screen-main {
  display: none;
  width: 100vw; height: 100vh;
  position: relative;
  background: #000;
}

/* Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾ â€” 80% Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹, Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° */
#remote-video {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 80vh;
  object-fit: cover;
  background: #000;
  z-index: 1;
}

/* Ğ—Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ° ĞºĞ¾Ğ³Ğ´Ğ° remote Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ */
#remote-placeholder {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 80vh;
  display: flex;
  flex-direction: column;
  align-items: center; justify-content: center;
  background: linear-gradient(135deg, #080c10 0%, #0d1520 100%);
  z-index: 2;
  gap: 1rem;
}
#remote-placeholder .ph-icon {
  font-size: 3rem;
  opacity: 0.3;
}
#remote-placeholder .ph-text {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  color: var(--text-dim);
  letter-spacing: 0.1em;
}

/* Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾ â€” selfie Ğ² ÑƒĞ³Ğ»Ñƒ */
#local-video {
  position: fixed;
  bottom: 12px;
  right: 12px;
  width: clamp(120px, 20vw, 280px);
  height: auto;
  aspect-ratio: 4/3;
  object-fit: cover;
  z-index: 10;
  border-radius: 10px;
  border: 2px solid rgba(0, 212, 255, 0.3);
  box-shadow: 0 4px 24px rgba(0,0,0,0.7), 0 0 12px rgba(0,212,255,0.15);
  background: #000;
  transform: scaleX(-1); /* Ğ—ĞµÑ€ĞºĞ°Ğ»Ğ¾ Ğ´Ğ»Ñ selfie */
}

/* â”€â”€â”€ ĞŸĞĞĞ•Ğ›Ğ¬ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#controls {
  position: fixed;
  bottom: 0; left: 0;
  width: 100%; height: 20vh;
  background: linear-gradient(to top, rgba(8,12,16,0.98) 60%, transparent);
  z-index: 5;
  display: flex;
  align-items: flex-end;
  padding-bottom: 8px;
}

.controls-inner {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 16px;
}

/* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ²Ğ¾Ğ½ĞºĞ¾Ğ¼ */
.ctrl-btn {
  width: 44px; height: 44px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
  transition: transform 0.15s, box-shadow 0.15s;
  flex-shrink: 0;
}
.ctrl-btn:hover { transform: scale(1.1); }
.ctrl-btn:active { transform: scale(0.95); }

.ctrl-btn.mute   { background: var(--surface2); color: var(--text); }
.ctrl-btn.cam    { background: var(--surface2); color: var(--text); }
.ctrl-btn.hang   { background: var(--danger);   color: #fff; box-shadow: 0 0 12px rgba(255,68,102,0.4); }
.ctrl-btn.active-off { background: var(--danger); color: #fff; }

/* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ */
.conn-status {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 0.06em;
  flex-shrink: 0;
  white-space: nowrap;
}
.conn-status.connected { color: var(--success); }
.conn-status.connecting { color: #ffaa00; }

/* â”€â”€â”€ Ğ§ĞĞ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-toggle {
  position: fixed;
  top: 12px; right: 12px;
  z-index: 20;
  background: rgba(13,21,32,0.85);
  border: 1px solid var(--border);
  border-radius: 50px;
  padding: 6px 14px;
  display: flex; align-items: center; gap: 8px;
  cursor: pointer;
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-dim);
  transition: border-color 0.2s;
  backdrop-filter: blur(8px);
}
#chat-toggle:hover { border-color: var(--accent); color: var(--text); }
#chat-badge {
  background: var(--accent);
  color: #000;
  border-radius: 50%;
  width: 16px; height: 16px;
  font-size: 0.6rem;
  display: none;
  align-items: center; justify-content: center;
  font-weight: bold;
}
#chat-badge.visible { display: flex; }

#chat-panel {
  position: fixed;
  top: 0; right: -360px;
  width: min(340px, 90vw);
  height: 100vh;
  background: rgba(9, 14, 22, 0.97);
  border-left: 1px solid var(--border);
  z-index: 15;
  display: flex;
  flex-direction: column;
  transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(16px);
}
#chat-panel.open { right: 0; }

.chat-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.chat-header h3 {
  font-family: var(--font-mono);
  font-size: 0.8rem;
  letter-spacing: 0.12em;
  color: var(--accent);
}
.chat-close {
  background: none; border: none;
  color: var(--text-dim);
  cursor: pointer; font-size: 1.1rem;
  padding: 4px;
  transition: color 0.15s;
}
.chat-close:hover { color: var(--text); }

#chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  scroll-behavior: smooth;
}
#chat-messages::-webkit-scrollbar { width: 4px; }
#chat-messages::-webkit-scrollbar-track { background: transparent; }
#chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.msg-bubble {
  max-width: 86%;
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 0.85rem;
  line-height: 1.5;
  word-break: break-word;
}
.msg-bubble.mine {
  align-self: flex-end;
  background: linear-gradient(135deg, var(--accent2), #0055cc);
  color: #fff;
  border-bottom-right-radius: 4px;
}
.msg-bubble.theirs {
  align-self: flex-start;
  background: var(--surface2);
  color: var(--text);
  border-bottom-left-radius: 4px;
}
.msg-meta {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  color: rgba(255,255,255,0.4);
  margin-top: 3px;
}

.chat-input-row {
  padding: 10px 12px;
  border-top: 1px solid var(--border);
  display: flex; gap: 8px;
  flex-shrink: 0;
}
#chat-input {
  flex: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 10px;
  color: var(--text);
  font-size: 0.85rem;
  outline: none;
  resize: none;
  min-height: 36px;
  max-height: 90px;
  line-height: 1.4;
  font-family: var(--font-main);
}
#chat-input:focus { border-color: var(--accent); }
#chat-send {
  background: var(--accent2);
  border: none;
  border-radius: 6px;
  padding: 0 14px;
  color: #fff;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.15s;
  align-self: flex-end;
  height: 36px;
}
#chat-send:hover { background: var(--accent); color: #000; }

/* â”€â”€â”€ Ğ¡Ğ›ĞĞ¢-Ğ˜ĞĞ”Ğ˜ĞšĞĞ¢ĞĞ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#slot-indicator {
  position: fixed;
  top: 12px; left: 12px;
  z-index: 20;
  background: rgba(13,21,32,0.85);
  border: 1px solid var(--border);
  border-radius: 50px;
  padding: 5px 12px;
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 0.08em;
  backdrop-filter: blur(8px);
}
#slot-indicator span { color: var(--accent); }

/* â”€â”€â”€ Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast {
  position: fixed;
  bottom: 22vh; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(13,21,32,0.95);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 20px;
  font-family: var(--font-mono);
  font-size: 0.78rem;
  color: var(--text);
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s, transform 0.3s;
  white-space: nowrap;
  backdrop-filter: blur(12px);
}
#toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* â”€â”€â”€ ĞœĞ•Ğ”Ğ˜ĞĞ—ĞĞŸĞ ĞĞ¡Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 500px) {
  #local-video {
    width: 100px;
    bottom: 8px; right: 8px;
  }
  #chat-panel { width: 100vw; }
}

/* Scan-line ÑÑ„Ñ„ĞµĞºÑ‚ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… remote Ğ²Ğ¸Ğ´ĞµĞ¾ Ğ´Ğ»Ñ Ğ°Ñ‚Ğ¼Ğ¾ÑÑ„ĞµÑ€Ñ‹ */
#remote-video::after, .scanlines {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 80vh;
  background: repeating-linear-gradient(
    to bottom,
    transparent 0px,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
  pointer-events: none;
  z-index: 3;
}
</style>
</head>
<body>

<!-- â”€â”€â”€ Ğ­ĞšĞ ĞĞ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="screen-loading">
  <div class="logo">VIDEO<span>LINK</span></div>
  <div class="spinner"></div>
  <div class="status-msg" id="loading-msg">Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯...</div>
</div>

<!-- â”€â”€â”€ Ğ­ĞšĞ ĞĞ Ğ—ĞĞĞ¯Ğ¢Ğ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="screen-busy" style="display:none">
  <div class="logo">VIDEO<span>LINK</span></div>
  <div class="busy-icon">â›”</div>
  <div class="busy-title">Ğ›Ğ¸Ğ½Ğ¸Ñ Ğ·Ğ°Ğ½ÑÑ‚Ğ°</div>
  <div class="busy-sub">
    Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ²ĞµĞ´Ñ‘Ñ‚ÑÑ Ğ±ĞµÑĞµĞ´Ğ°.<br>
    ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.
  </div>
  <button class="retry-btn" onclick="retryJoin()">â†º ĞŸĞĞ’Ğ¢ĞĞ Ğ˜Ğ¢Ğ¬ ĞŸĞĞŸĞ«Ğ¢ĞšĞ£</button>
</div>

<!-- â”€â”€â”€ ĞĞ¡ĞĞĞ’ĞĞĞ™ Ğ­ĞšĞ ĞĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="screen-main">
  <!-- Ğ¡Ğ»Ğ¾Ñ‚-Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ -->
  <div id="slot-indicator">SLOT <span id="my-slot-num">?</span></div>

  <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ñ‡Ğ°Ñ‚Ğ° -->
  <div id="chat-toggle" onclick="toggleChat()">
    ğŸ’¬ Ğ§ĞĞ¢
    <span id="chat-badge"></span>
  </div>

  <!-- Remote Ğ²Ğ¸Ğ´ĞµĞ¾ (80% Ğ²Ñ‹ÑĞ¾Ñ‚Ñ‹) -->
  <video id="remote-video" autoplay playsinline></video>

  <!-- Ğ—Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ° Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ remote -->
  <div id="remote-placeholder">
    <div class="ph-icon">ğŸ‘¤</div>
    <div class="ph-text" id="ph-text">ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ• Ğ¡ĞĞ‘Ğ•Ğ¡Ğ•Ğ”ĞĞ˜ĞšĞ...</div>
  </div>

  <!-- Scanlines overlay -->
  <div class="scanlines"></div>

  <!-- Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ selfie Ğ²Ğ¸Ğ´ĞµĞ¾ (20%, fixed, overlay) -->
  <video id="local-video" autoplay playsinline muted></video>

  <!-- ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ -->
  <div id="controls">
    <div class="controls-inner">
      <button class="ctrl-btn mute" id="btn-mute"    onclick="toggleMute()"   title="ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½">ğŸ¤</button>
      <button class="ctrl-btn cam"  id="btn-cam"     onclick="toggleCam()"    title="ĞšĞ°Ğ¼ĞµÑ€Ğ°">ğŸ“·</button>
      <button class="ctrl-btn hang" id="btn-hang"    onclick="hangUp()"       title="Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ">ğŸ“µ</button>
      <div class="conn-status" id="conn-status">ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ•...</div>
    </div>
  </div>

  <!-- Ğ§Ğ°Ñ‚-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ -->
  <div id="chat-panel">
    <div class="chat-header">
      <h3>ğŸ’¬ Ğ¢Ğ•ĞšĞ¡Ğ¢ĞĞ’Ğ«Ğ™ Ğ§ĞĞ¢</h3>
      <button class="chat-close" onclick="toggleChat()">âœ•</button>
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input-row">
      <textarea id="chat-input" placeholder="Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." rows="1"
        onkeydown="chatKeydown(event)"></textarea>
      <button id="chat-send" onclick="sendMessage()">â¤</button>
    </div>
  </div>
</div>

<!-- Ğ¢Ğ¾ÑÑ‚-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
  stunServer:    '<?= STUN_SERVER ?>',
  pingInterval:  3000,   // Ğ¼Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ ping-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸
  pollInterval:  900,    // Ğ¼Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ poll-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸
  peerTimeout:   12000,  // Ğ¼Ñ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… peer ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ offline
  retryDelay:    5000,   // Ğ¼Ñ Ğ´Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ join Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾ÑÑ‚Ğ¸
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞĞ• Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let myClientId   = null;   // Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ID ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
let mySlot       = null;   // 1 Ğ¸Ğ»Ğ¸ 2
let peerSlot     = null;   // Ğ¡Ğ»Ğ¾Ñ‚ ÑĞ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸ĞºĞ°
let isCaller     = false;  // true ĞµÑĞ»Ğ¸ slot1 (ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ offer)

let pc           = null;   // RTCPeerConnection
let localStream  = null;   // MediaStream (ĞºĞ°Ğ¼ĞµÑ€Ğ° + Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½)

let pingTimer    = null;
let pollTimer    = null;

let msgOffset    = 0;      // Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
let unreadCount  = 0;
let chatOpen     = false;

let peerLastSeen = 0;      // ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€Ğ°Ğ· Ğ²Ğ¸Ğ´ĞµĞ»Ğ¸ peer
let peerConnected = false; // WebRTC ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾

let micEnabled   = true;
let camEnabled   = true;

let isHungUp     = false;  // Ğ¤Ğ»Ğ°Ğ³ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ·Ğ²Ğ¾Ğ½ĞºĞ°

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° â€” Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹.
 * Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ clientId Ğ¸Ğ· localStorage ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ.
 */
window.addEventListener('load', () => {
  myClientId = localStorage.getItem('vcClientId');
  if (!myClientId) {
    myClientId = randomHex(16);
    localStorage.setItem('vcClientId', myClientId);
  }
  startJoin();
});

/**
 * ĞŸÑ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ leave (best effort).
 */
window.addEventListener('beforeunload', () => {
  if (mySlot && myClientId) {
    navigator.sendBeacon(scriptUrl('leave'), formData({ clientId: myClientId, slot: mySlot }));
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOIN â€” ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ• Ğš Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ ÑĞ»Ğ¾Ñ‚ Ñƒ ÑĞµÑ€Ğ²ĞµÑ€Ğ°.
 * ĞŸÑ€Ğ¸ ÑƒÑĞ¿ĞµÑ…Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµĞ´Ğ¸Ğ° Ğ¸ WebRTC.
 */
async function startJoin() {
  setLoadingMsg('Ğ—ĞĞŸĞ ĞĞ¡ Ğ¡Ğ›ĞĞ¢Ğ...');
  showScreen('loading');

  try {
    const res = await api('join', { clientId: myClientId });

    if (res.status === 'busy') {
      showScreen('busy');
      return;
    }

    mySlot   = res.slot;
    peerSlot = res.peerSlot;
    isCaller = (mySlot === 1); // Slot1 ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ offer

    document.getElementById('my-slot-num').textContent = mySlot;

    setLoadingMsg('Ğ—ĞĞŸĞ ĞĞ¡ ĞœĞ•Ğ”Ğ˜Ğ...');
    await initMedia();

    showScreen('main');

    // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ heartbeat Ğ¸ polling
    startPing();
    startPolling();

    if (res.peerConnected) {
      // Peer ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ â€” ĞµÑĞ»Ğ¸ Ğ¼Ñ‹ caller, ÑÑ€Ğ°Ğ·Ñƒ ÑˆĞ»Ñ‘Ğ¼ offer
      if (isCaller) {
        await initiatCall();
      }
    }

    toast(`ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½ ĞºĞ°Ğº ĞĞ±Ğ¾Ğ½ĞµĞ½Ñ‚ ${mySlot}`, 3000);

  } catch (err) {
    console.error('Join error:', err);
    setLoadingMsg('ĞĞ¨Ğ˜Ğ‘ĞšĞ: ' + err.message);
    setTimeout(startJoin, 5000);
  }
}

/** ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ° join (Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ") */
function retryJoin() {
  startJoin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞœĞ•Ğ”Ğ˜Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ĞºĞ°Ğ¼ĞµÑ€Ğµ Ğ¸ Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ */
async function initMedia() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' },
      audio: { echoCancellation: true, noiseSuppression: true },
    });
    document.getElementById('local-video').srcObject = localStream;
  } catch (err) {
    // Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ²Ğ¸Ğ´ĞµĞ¾ â€” Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°ÑƒĞ´Ğ¸Ğ¾
    console.warn('Media error, trying audio only:', err);
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (e) {
      toast('ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ĞºĞ°Ğ¼ĞµÑ€Ğµ/Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ñƒ', 4000);
      throw new Error('Media access denied');
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WebRTC â€” Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ•ĞĞ˜Ğ•Ğœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ RTCPeerConnection Ñ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¼Ğ¸ STUN-ÑĞµÑ€Ğ²ĞµÑ€Ğ°Ğ¼Ğ¸ */
function createPeerConnection() {
  if (pc) {
    pc.close();
    pc = null;
  }

  pc = new RTCPeerConnection({
    iceServers: [
      { urls: CONFIG.stunServer },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'stun:stun2.l.google.com:19302' },
    ]
  });

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞºĞ¸
  if (localStream) {
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  // Remote Ñ‚Ñ€ĞµĞºĞ¸ â€” Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ğ²Ğ¸Ğ´ĞµĞ¾ ÑĞ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸ĞºĞ°
  pc.ontrack = (event) => {
    const remoteVideo = document.getElementById('remote-video');
    if (remoteVideo.srcObject !== event.streams[0]) {
      remoteVideo.srcObject = event.streams[0];
      document.getElementById('remote-placeholder').style.display = 'none';
      setConnStatus('Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ•ĞĞ', 'connected');
      peerConnected = true;
    }
  };

  // ICE ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ñ‹ â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ peer Ñ‡ĞµÑ€ĞµĞ· ÑĞµÑ€Ğ²ĞµÑ€
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      api('post_ice', {
        clientId: myClientId,
        slot: mySlot,
        candidate: JSON.stringify(event.candidate),
      }).catch(console.warn);
    }
  };

  // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ICE ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ
  pc.oniceconnectionstatechange = () => {
    const state = pc.iceConnectionState;
    console.log('ICE state:', state);
    if (state === 'connected' || state === 'completed') {
      setConnStatus('Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ•ĞĞ', 'connected');
      peerConnected = true;
      document.getElementById('ph-text').textContent = 'Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ•ĞĞ˜Ğ• Ğ£Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ•ĞĞ';
    } else if (state === 'checking') {
      setConnStatus('ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ•...', 'connecting');
    } else if (state === 'failed' || state === 'disconnected') {
      setConnStatus('Ğ ĞĞ—Ğ Ğ«Ğ’ Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ•ĞĞ˜Ğ¯', '');
      peerConnected = false;
    }
  };

  return pc;
}

/**
 * Caller (slot1) Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€ÑƒĞµÑ‚ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº:
 * ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ offer Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ĞµĞ³Ğ¾ Ñ‡ĞµÑ€ĞµĞ· ÑĞµÑ€Ğ²ĞµÑ€.
 */
async function initiatCall() {
  console.log('Initiating call as caller (slot1)...');
  setConnStatus('Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• OFFER...', 'connecting');

  createPeerConnection();

  const offer = await pc.createOffer({
    offerToReceiveAudio: true,
    offerToReceiveVideo: true,
  });
  await pc.setLocalDescription(offer);

  await api('post_offer', {
    clientId: myClientId,
    slot: mySlot,
    offer: JSON.stringify(offer),
  });

  setConnStatus('ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ• ĞĞ¢Ğ’Ğ•Ğ¢Ğ...', 'connecting');
}

/**
 * Callee (slot2) Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» offer â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ answer.
 */
async function handleOffer(offerJson) {
  console.log('Received offer, creating answer...');

  createPeerConnection();
  setConnStatus('ĞŸĞĞ›Ğ£Ğ§Ğ•Ğ OFFER...', 'connecting');

  const offer = JSON.parse(offerJson);
  await pc.setRemoteDescription(new RTCSessionDescription(offer));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await api('post_answer', {
    clientId: myClientId,
    slot: mySlot,
    answer: JSON.stringify(answer),
  });

  setConnStatus('ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ• ICE...', 'connecting');
}

/** Caller Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» answer */
async function handleAnswer(answerJson) {
  if (!pc || pc.signalingState === 'stable') return;
  console.log('Received answer, setting remote description...');
  const answer = JSON.parse(answerJson);
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
}

/** ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ICE ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚ Ğ¾Ñ‚ peer */
async function handleIceCandidate(candidateJson) {
  if (!pc) return;
  try {
    const candidate = JSON.parse(candidateJson);
    await pc.addIceCandidate(new RTCIceCandidate(candidate));
  } catch (e) {
    console.warn('ICE candidate error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEARTBEAT (PING)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¸Ğ½Ğ³ÑƒĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ»Ğ¾Ñ‚ Ğ½Ğµ Ğ¸ÑÑ‚Ñ‘Ğº */
function startPing() {
  if (pingTimer) clearInterval(pingTimer);
  pingTimer = setInterval(async () => {
    if (!myClientId || !mySlot || isHungUp) return;
    try {
      await api('ping', { clientId: myClientId, slot: mySlot });
    } catch (e) {
      console.warn('Ping failed:', e);
    }
  }, CONFIG.pingInterval);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLLING â€” ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ• Ğ¡ĞĞ‘Ğ«Ğ¢Ğ˜Ğ™ ĞĞ¢ Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€ Ğ½Ğ° Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚:
 * - SDP offer/answer
 * - ICE ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ğ²
 * - ĞĞ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚Ğ°
 * - Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ peer
 */
function startPolling() {
  if (pollTimer) clearTimeout(pollTimer);

  const doPoll = async () => {
    if (isHungUp) return;

    try {
      const data = await api('poll', {
        clientId:  myClientId,
        slot:      mySlot,
        msgOffset: msgOffset,
      });

      if (data.status !== 'ok') return;

      // â”€â”€ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¸Ğ½Ğ³Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» offer (Ğ´Ğ»Ñ callee)
      if (data.offers && data.offers.length > 0) {
        for (const offerJson of data.offers) {
          await handleOffer(offerJson);
        }
      }

      // Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» answer (Ğ´Ğ»Ñ caller)
      if (data.answers && data.answers.length > 0) {
        for (const answerJson of data.answers) {
          await handleAnswer(answerJson);
        }
      }

      // ICE ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ñ‹
      if (data.ices && data.ices.length > 0) {
        for (const ice of data.ices) {
          await handleIceCandidate(ice);
        }
      }

      // â”€â”€ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‡Ğ°Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      if (data.msgs && data.msgs.length > 0) {
        for (const msg of data.msgs) {
          renderMessage(msg);
          if (!chatOpen && msg.from !== mySlot) {
            unreadCount++;
            updateBadge();
          }
        }
        msgOffset = data.msgTotal;
        scrollChatToBottom();
      }

      // â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ peer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      if (data.peerConnected) {
        peerLastSeen = Date.now();

        // Ğ•ÑĞ»Ğ¸ peer Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ğ»ÑÑ Ğ¸ Ğ¼Ñ‹ caller â€” Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº
        if (isCaller && (!pc || pc.signalingState === 'closed' || pc.signalingState === 'stable' && !peerConnected)) {
          // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ½Ğµ ÑƒĞ¶Ğµ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ
          if (!pc || pc.signalingState === 'closed') {
            await initiatCall();
          }
        }

        document.getElementById('remote-placeholder').style.display = 'none';
        if (!peerConnected) {
          document.getElementById('ph-text').textContent = 'Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ•ĞĞ˜Ğ¯...';
        }

      } else {
        // Peer Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚
        const wasConnected = peerLastSeen > 0;
        if (wasConnected && Date.now() - peerLastSeen > CONFIG.peerTimeout) {
          onPeerLeft();
        }
        document.getElementById('remote-placeholder').style.display = 'flex';
        document.getElementById('ph-text').textContent = 'ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ• Ğ¡ĞĞ‘Ğ•Ğ¡Ğ•Ğ”ĞĞ˜ĞšĞ...';
      }

    } catch (err) {
      console.warn('Poll error:', err);
    }

    // ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ poll
    if (!isHungUp) {
      pollTimer = setTimeout(doPoll, CONFIG.pollInterval);
    }
  };

  doPoll();
}

/** Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ĞºĞ¾Ğ³Ğ´Ğ° peer Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ğ»ÑÑ */
function onPeerLeft() {
  if (peerConnected || peerLastSeen === 0) {
    peerConnected = false;
    peerLastSeen  = 0;

    // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ PC â€” Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ´Ğ¸Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹
    if (pc) {
      pc.close();
      pc = null;
    }

    const remoteVideo = document.getElementById('remote-video');
    remoteVideo.srcObject = null;
    document.getElementById('remote-placeholder').style.display = 'flex';
    document.getElementById('ph-text').textContent = 'Ğ¡ĞĞ‘Ğ•Ğ¡Ğ•Ğ”ĞĞ˜Ğš ĞĞ¢ĞšĞ›Ğ®Ğ§Ğ˜Ğ›Ğ¡Ğ¯';
    setConnStatus('ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ•...', '');

    toast('Ğ¡Ğ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸Ğº Ğ¿Ğ¾ĞºĞ¸Ğ½ÑƒĞ» ÑĞµÑÑĞ¸Ñ', 4000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ§ĞĞ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ */
async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';

  try {
    await api('post_msg', {
      clientId: myClientId,
      slot: mySlot,
      text: text,
    });
  } catch (e) {
    toast('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ', 2000);
  }
}

/** Enter Ğ±ĞµĞ· Shift Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ */
function chatKeydown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
  // ĞĞ²Ñ‚Ğ¾-Ğ²Ñ‹ÑĞ¾Ñ‚Ğ° textarea
  setTimeout(() => {
    const el = event.target;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 90) + 'px';
  }, 0);
}

/**
 * Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ° Ğ² DOM.
 * Ğ­ĞºÑ€Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ HTML Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸.
 */
function renderMessage(msg) {
  const container = document.getElementById('chat-messages');
  const isMine = (msg.from === mySlot);

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble ' + (isMine ? 'mine' : 'theirs');

  const text = document.createElement('div');
  text.textContent = msg.text; // textContent Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ (Ğ½Ğµ innerHTML!)

  const meta = document.createElement('div');
  meta.className = 'msg-meta';
  meta.textContent = formatTime(msg.ts) + (isMine ? ' Â· Ğ²Ñ‹' : ' Â· ÑĞ¾Ğ±ĞµÑĞµĞ´Ğ½Ğ¸Ğº');

  bubble.appendChild(text);
  bubble.appendChild(meta);
  container.appendChild(bubble);
}

function scrollChatToBottom() {
  const el = document.getElementById('chat-messages');
  el.scrollTop = el.scrollHeight;
}

function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chat-panel').classList.toggle('open', chatOpen);
  if (chatOpen) {
    unreadCount = 0;
    updateBadge();
    scrollChatToBottom();
    document.getElementById('chat-input').focus();
  }
}

function updateBadge() {
  const badge = document.getElementById('chat-badge');
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
    badge.classList.add('visible');
  } else {
    badge.classList.remove('visible');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞœĞ•Ğ”Ğ˜Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleMute() {
  if (!localStream) return;
  micEnabled = !micEnabled;
  localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
  const btn = document.getElementById('btn-mute');
  btn.textContent = micEnabled ? 'ğŸ¤' : 'ğŸ”‡';
  btn.classList.toggle('active-off', !micEnabled);
  toast(micEnabled ? 'ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½' : 'ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½', 2000);
}

function toggleCam() {
  if (!localStream) return;
  camEnabled = !camEnabled;
  localStream.getVideoTracks().forEach(t => t.enabled = camEnabled);
  const btn = document.getElementById('btn-cam');
  btn.textContent = camEnabled ? 'ğŸ“·' : 'ğŸš«';
  btn.classList.toggle('active-off', !camEnabled);
  toast(camEnabled ? 'ĞšĞ°Ğ¼ĞµÑ€Ğ° Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°' : 'ĞšĞ°Ğ¼ĞµÑ€Ğ° Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ°', 2000);
}

/** Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµÑ‚ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº Ğ¸ Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ñ€ĞµÑÑƒÑ€ÑÑ‹ */
async function hangUp() {
  isHungUp = true;

  if (pingTimer) clearInterval(pingTimer);
  if (pollTimer) clearTimeout(pollTimer);

  if (pc) { pc.close(); pc = null; }
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }

  try {
    await api('leave', { clientId: myClientId, slot: mySlot });
  } catch (e) {}

  // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
  setTimeout(() => window.location.reload(), 1500);
  toast('Ğ—Ğ²Ğ¾Ğ½Ğ¾Ğº Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº...', 1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ URL Ğ´Ğ»Ñ API-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° */
function scriptUrl(action) {
  return '?action=' + encodeURIComponent(action);
}

/**
 * Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ POST-Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº API.
 * Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€Ğ°ÑĞ¿Ğ°Ñ€ÑĞµĞ½Ğ½Ñ‹Ğ¹ JSON.
 */
async function api(action, params = {}) {
  const body = new URLSearchParams({ action, ...params });
  const res = await fetch(window.location.pathname + '?action=' + action, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString(),
  });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

/** Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ FormData Ğ¸Ğ· Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° (Ğ´Ğ»Ñ sendBeacon) */
function formData(obj) {
  const fd = new URLSearchParams();
  for (const [k, v] of Object.entries(obj)) fd.append(k, v);
  return fd;
}

/** Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ hex-string */
function randomHex(len) {
  const arr = new Uint8Array(len / 2);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
}

/** Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ unix timestamp Ğ² HH:MM */
function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts * 1000);
  return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}

/** ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½ */
function showScreen(name) {
  document.getElementById('screen-loading').style.display = name === 'loading' ? 'flex' : 'none';
  document.getElementById('screen-busy').style.display    = name === 'busy'    ? 'flex' : 'none';
  document.getElementById('screen-main').style.display    = name === 'main'    ? 'block': 'none';
}

function setLoadingMsg(msg) {
  document.getElementById('loading-msg').textContent = msg;
}

function setConnStatus(msg, cls) {
  const el = document.getElementById('conn-status');
  el.textContent = msg;
  el.className = 'conn-status ' + (cls || '');
}

/** ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ */
let toastTimer = null;
function toast(msg, duration = 3000) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), duration);
}
</script>
</body>
</html>
